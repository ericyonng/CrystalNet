# 文件监视

----

## 背景

* 配置文件繁杂, 热更配置, 要实现及时更新的复杂度较高
* 希望通过实现监视器的东西，它自动的监视文件的变化及时的更新配置等内存内容, 自己形成一个闭环，类似C# 的OptionMonitor那样



## 规则

* 通过定时的监听文件大小变化，文件修改时间变化，以最小的代价来监听文件变化，及时更新内存内容
* 需要提供一个FileMonitorDeserializer 反序列化器，以便将文件内容反序列化成对象
* 需要提供一个Poller，用于文件的监听
* 更新文件应该保证原子更新，rename是原子的，更新文件的流程建议使用自动化
  * 先把新文件重命名成.new文件
  * 再把旧文件重命名成.back文件
  * 最后把.new文件更名为最终文件
* 避免文件只更新一半的中间状态，文件监视器只是做了比较简单的热更新, 无法做到文件的完整性校验，因为那样消耗太大，文件完整性校验，一般是在启服加载那种可以有时间去读取meta文件的sha256值并校验文件计算出来的sha256来判断完整性, 本功能无法做到，也不合适
* 为了避免连续的更新导致不停的更新, 文件监视会在监视到变更的时候留5秒的观察期，如果5秒观察期内仍然有更新, 则继续等待, 直到文件最终稳定后再用最终的内容来更新内存对象

